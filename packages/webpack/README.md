# `@patataf/webpack`

Although not mandatory, this repository contains webpack configuration and scripts to produce

- a dev-server with hot module reloading, both for the frontend and the backend (TODO)
- optimized production bundle

## Installation

Install this package and its dependencies :

```
yarn add @patataf/webpack --dev
yarn add @patataf/frontend @patataf/backend @patataf/server
```

Then in your `package.json`, add scripts for the various commands :

```
"scripts": {
  "build": "NODE_ENV=production pf-build",
  "start": "NODE_ENV=development pf-start"
}
```

## Usage

### Assumptions

The configuration requires your project to follow a specific convention.

- All sources must be placed in folder called `src`
- There must be a file called `src/backend.ts`. It must have a default export containing the backend configuration.
- There must be a file called `src/frontend.ts`. It must have a default export containing the frontend configuration.
- When using the dev-server, the `.env` file must be present and properly configured.

### Dev-server

To start the dev-server, you only need to run `pf-start` using the script you setup in the installation phase

```
yarn start
```

The server is then accessible as configured in the `.env` file, like a regular production server would.
If you update a source file, it will trigger recompilation and hot module reloading, both for the in-browser client, and for the server (SSR and backend).

### Build bundle

To generate a bundle, you should run `pf-build` using the script you setup in the installation phase.
You should specify a value (`development` or `production`) for the `NODE_ENV` environment variable.

```
yarn build
```

The output server is located at `build/server.js`. You can run it by doing

```
node build/server
```

It will also automatically serve the `public` folder which should contain files generated by webpack,
including the client bundle.

A bundle analyzer file will also be generated at `public/report.html`.
It is really useful to understand what's in your bundle and optimize its size.

## Todo

- [ ] Fix the requireFromFile on server recompilation. We should clean the cache, and possibly use HMR to avoid memory leaks.
- [ ] Separate SSR and backend so that modifying one does not imply a recompilation of both.
